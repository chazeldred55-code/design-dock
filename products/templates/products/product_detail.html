{% extends "base.html" %}
{% load static %}

{% block page_header %}
<div class="container header-container">
  <div class="row">
    <div class="col"></div>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="overlay"></div>

<div class="container py-4">
  <div class="row">

    <!-- Preview -->
    <div class="col-12 col-lg-6 mb-4">
      <div class="dd-card overflow-hidden">
        {% if product.image %}
          <a href="{{ product.image.url }}" target="_blank" class="d-block">
            <img
              class="img-fluid"
              src="{{ product.image.url }}"
              alt="{{ product.name }}"
              style="width:100%; height: 420px; object-fit: cover;"
            >
          </a>
        {% else %}
          <a href="{% static 'images/noimage.png' %}" target="_blank" class="d-block">
            <img
              class="img-fluid"
              src="{% static 'images/noimage.png' %}"
              alt="{{ product.name }}"
              style="width:100%; height: 420px; object-fit: cover;"
            >
          </a>
        {% endif %}
      </div>

      <div class="mt-3 d-flex flex-wrap" style="gap:.5rem;">
        <span class="badge badge-white px-3 py-2">
          <i class="fas fa-eye mr-2"></i>Preview opens in new tab
        </span>
        <span class="badge badge-white px-3 py-2">
          <i class="fas fa-bolt mr-2"></i>Ready to use
        </span>
      </div>
    </div>

    <!-- Details -->
    <div class="col-12 col-lg-6">
      <div class="dd-card p-4">

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h2 class="mb-1" style="font-weight: 800; color: var(--dd-text);">
              {{ product.name }}
            </h2>

            {% if product.category %}
              <div class="mt-2">
                <a class="text-decoration-none"
                   href="{% url 'products' %}?category={{ product.category.name }}"
                   style="color: var(--dd-muted);">
                  <i class="fas fa-tag mr-1"></i>
                  {{ product.category.friendly_name|default:product.category.name }}
                </a>
              </div>
            {% endif %}
          </div>

          <div class="text-right">
            <div class="badge badge-white px-3 py-2" style="font-weight: 800; font-size: 1rem;">
              <span style="opacity:.75;">Price:</span>
              <span id="license-price">£{{ product.price_personal|floatformat:2 }}</span>
            </div>

            <div class="mt-2">
              {% if product.rating %}
                <small style="color: var(--dd-muted);">
                  <i class="fas fa-star mr-1" style="color: var(--dd-warning);"></i>
                  {{ product.rating }} / 5
                </small>
              {% else %}
                <small style="color: var(--dd-muted);">No rating yet</small>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Description -->
        {% if product.description %}
          <div class="mt-4" style="color: var(--dd-text); opacity: .92; line-height: 1.6;">
            {{ product.description }}
          </div>
        {% endif %}

        <hr class="my-4" style="border-color: var(--dd-border);">

        <!-- Purchase form (digital / license based) -->
        <form class="form" action="{% url 'add_to_bag' product.id %}" method="POST">
          {% csrf_token %}

          <div class="form-row">

            <!-- License -->
            <div class="col-12">
              <label for="id_license_type" class="mb-2" style="color: var(--dd-muted);">
                License
              </label>
              <div class="form-group">
                <select class="form-control"
                        style="background: rgba(255,255,255,.04);
                               color: var(--dd-text);
                               border: 1px solid var(--dd-border);
                               border-radius: 12px;"
                        name="license_type"
                        id="id_license_type">
                  <option value="personal" selected>Personal</option>
                  <option value="commercial">Commercial</option>
                  <option value="extended">Extended</option>
                </select>
                <small class="form-text" style="color: var(--dd-muted);">
                  Choose how you plan to use this template.
                </small>
              </div>
            </div>

            <!-- Quantity -->
            <div class="col-12 mt-2">
              <label class="mb-2" style="color: var(--dd-muted);">
                Quantity
              </label>
              <div class="form-group">
                <input class="form-control"
                       style="background: rgba(255,255,255,.04);
                              color: var(--dd-text);
                              border: 1px solid var(--dd-border);
                              border-radius: 12px;"
                       type="number"
                       name="quantity"
                       value="1"
                       min="1"
                       max="99">
              </div>
            </div>

            <div class="col-12 d-flex flex-wrap mt-2" style="gap:.75rem;">
              <input type="submit"
                     class="btn btn-dd-primary text-uppercase"
                     value="Add to Bag">

              <a href="{% url 'products' %}"
                 class="btn btn-dd-outline text-uppercase">
                Back to Templates
              </a>
            </div>

            <input type="hidden" name="redirect_url" value="{{ request.path }}">
          </div>
        </form>

        <div class="mt-4" style="color: var(--dd-muted); font-size: .95rem;">
          <i class="fas fa-lock mr-2"></i>Secure checkout powered by Stripe.
        </div>

      </div>
    </div>

  </div>
</div>

{# tiny inline script to update price when license changes #}
<script>
  (function () {
    const select = document.getElementById("id_license_type");
    const priceEl = document.getElementById("license-price");

    if (!select || !priceEl) return;

    const prices = {
      personal: "{{ product.price_personal|floatformat:2 }}",
      commercial: "{{ product.price_commercial|floatformat:2 }}",
      extended: "{{ product.price_extended|floatformat:2 }}"
    };

    function updatePrice() {
      const val = (select.value || "personal").toLowerCase();
      priceEl.textContent = "£" + (prices[val] || prices.personal);
    }

    select.addEventListener("change", updatePrice);
    updatePrice();
  })();
</script>
{% endblock %}
