{% extends "base.html" %}
{% load static %}

{% block page_header %}
<div class="container header-container">
  <div class="row">
    <div class="col"></div>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="overlay"></div>

<div class="container-fluid">

  <!-- Page Title -->
  <div class="row">
    <div class="col text-center mt-4">
      <h2 class="mb-2" style="font-weight: 800; color: var(--dd-text);">Templates</h2>
      <p class="mb-0" style="color: var(--dd-muted);">
        Browse reusable UI kits, components, and design assets.
      </p>
      <hr class="w-50 mt-3 mb-1" style="border-color: var(--dd-border);">
    </div>
  </div>

  <!-- Selected categories -->
  {% if current_categories %}
    <div class="row">
      <div class="col text-center">
        {% for c in current_categories %}
          <a class="category-badge text-decoration-none"
             href="{% url 'products' %}?category={{ c.name }}">
            <span class="p-2 mt-2 badge badge-white rounded-0">
              {{ c.friendly_name|default:c.name }}
            </span>
          </a>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <!-- Templates Grid -->
  <div class="row">
    <div class="product-container col-10 offset-1">

      <!-- Count + reset + sorting -->
      <div class="row mt-3 mb-3 align-items-center">

        <div class="col-12 col-md-6 my-2">
          <p class="mb-0" style="color: var(--dd-muted);">
            {% if search_term or current_categories or current_sorting != 'None_None' %}
              <a href="{% url 'products' %}" style="color: var(--dd-text); opacity: .85;">All Templates</a>
              <span style="opacity:.6;">|</span>
            {% endif %}
            <span style="color: var(--dd-text); font-weight: 700;">{{ products|length }}</span>
            <span style="opacity:.85;">template{{ products|length|pluralize }}</span>
            {% if search_term %}
              <span style="opacity:.75;">found for</span>
              <strong>"{{ search_term }}"</strong>
            {% endif %}
          </p>
        </div>

        <div class="col-12 col-md-6 my-2 d-flex justify-content-center justify-content-md-end">
          <div class="sort-select-wrapper w-75 w-md-50">
            <select id="sort-selector"
                    class="custom-select custom-select-sm"
                    style="background: rgba(255,255,255,.04);
                           color: var(--dd-text);
                           border: 1px solid var(--dd-border);
                           border-radius: 12px;">
              <option value="reset" {% if current_sorting == "None_None" %}selected{% endif %}>Sort by...</option>
              <option value="price_asc" {% if current_sorting == "price_asc" %}selected{% endif %}>Price (low to high)</option>
              <option value="price_desc" {% if current_sorting == "price_desc" %}selected{% endif %}>Price (high to low)</option>
              <option value="rating_asc" {% if current_sorting == "rating_asc" %}selected{% endif %}>Rating (low to high)</option>
              <option value="rating_desc" {% if current_sorting == "rating_desc" %}selected{% endif %}>Rating (high to low)</option>
              <option value="name_asc" {% if current_sorting == "name_asc" %}selected{% endif %}>Name (A-Z)</option>
              <option value="name_desc" {% if current_sorting == "name_desc" %}selected{% endif %}>Name (Z-A)</option>
              <option value="category_asc" {% if current_sorting == "category_asc" %}selected{% endif %}>Category (A-Z)</option>
              <option value="category_desc" {% if current_sorting == "category_desc" %}selected{% endif %}>Category (Z-A)</option>
            </select>
          </div>
        </div>

      </div>

      <div class="row">
        {% for product in products %}
          <div class="col-sm-6 col-md-6 col-lg-4 col-xl-3 mb-4">

            <div class="dd-card h-100 overflow-hidden">

              <!-- Image -->
              <a href="{% url 'product_detail' product.id %}" class="d-block">
                {% if product.image %}
                  <img class="img-fluid"
                       src="{{ product.image.url }}"
                       alt="{{ product.name }}"
                       style="width:100%; height: 190px; object-fit: cover;">
                {% else %}
                  <img class="img-fluid"
                       src="{% static 'images/noimage.png' %}"
                       alt="{{ product.name }}"
                       style="width:100%; height: 190px; object-fit: cover;">
                {% endif %}
              </a>

              <!-- Body -->
              <div class="p-3">
                <div class="d-flex justify-content-between align-items-start">
                  <h6 class="mb-1" style="font-weight: 800; color: var(--dd-text);">
                    {{ product.name }}
                  </h6>
                  <span class="badge badge-white px-2 py-1" style="font-variant-numeric: tabular-nums;">
                    Â£{{ product.price }}
                  </span>
                </div>

                {% if product.category %}
                  <div class="mt-2">
                    <a href="{% url 'products' %}?category={{ product.category.name }}"
                       class="text-decoration-none"
                       style="color: var(--dd-muted);">
                      <i class="fas fa-tag mr-1"></i>
                      {{ product.category.friendly_name|default:product.category.name }}
                    </a>
                  </div>
                {% endif %}

                <div class="mt-2 d-flex align-items-center justify-content-between">
                  {% if product.rating %}
                    <small style="color: var(--dd-muted);">
                      <i class="fas fa-star mr-1" style="color: var(--dd-warning);"></i>
                      {{ product.rating }} / 5
                    </small>
                  {% else %}
                    <small style="color: var(--dd-muted);">No rating yet</small>
                  {% endif %}

                  <a href="{% url 'product_detail' product.id %}"
                     class="btn btn-dd-outline btn-sm text-uppercase"
                     style="padding:.35rem .6rem;">
                    View
                  </a>
                </div>
              </div>

            </div>

          </div>

          {% if forloop.counter|divisibleby:4 %}
            <div class="col-12 d-none d-xl-block mb-5"><hr style="border-color: var(--dd-border);"></div>
          {% endif %}
        {% empty %}
          <div class="col text-center mt-5">
            <p class="lead" style="color: var(--dd-muted);">No templates found.</p>
          </div>
        {% endfor %}
      </div>

    </div>
  </div>

</div>

<!-- Back to top button -->
<div class="btt-button shadow-sm rounded-0"
     style="background: rgba(255,255,255,.06); border: 1px solid var(--dd-border);">
  <a class="btt-link d-flex h-100">
    <i class="fas fa-arrow-up mx-auto my-auto" style="color: var(--dd-text);"></i>
  </a>
</div>

{% endblock %}

{% block postloadjs %}
{{ block.super }}
<script>
  $('#sort-selector').change(function() {
    var currentUrl = new URL(window.location);
    var selectedVal = $(this).val();

    if (selectedVal != "reset") {
      var sort = selectedVal.split("_")[0];
      var direction = selectedVal.split("_")[1];

      currentUrl.searchParams.set("sort", sort);
      currentUrl.searchParams.set("direction", direction);
      window.location.replace(currentUrl);
    } else {
      currentUrl.searchParams.delete("sort");
      currentUrl.searchParams.delete("direction");
      window.location.replace(currentUrl);
    }
  });

  $('.btt-link').click(function(e) {
    window.scrollTo(0, 0);
  });
</script>
{% endblock %}
