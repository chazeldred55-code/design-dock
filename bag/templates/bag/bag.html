{# bag/templates/bag/bag.html #}
{% extends "base.html" %}
{% load static %}

{% block page_header %}
<div class="container header-container">
  <div class="row">
    <div class="col"></div>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="overlay"></div>

<div class="container mb-5">

  <!-- Header -->
  <div class="row">
    <div class="col mt-4">
      <div class="d-flex align-items-center justify-content-between flex-wrap" style="gap: 1rem;">
        <div>
          <h2 class="mb-1" style="font-weight: 800; color: var(--dd-text);">
            Your Bag
          </h2>
          <p class="mb-0" style="color: var(--dd-muted);">
            Review items, adjust quantities, then continue to secure checkout.
          </p>
        </div>

        <a href="{% url 'products' %}" class="btn btn-dd-outline text-uppercase">
          <i class="fas fa-arrow-left mr-2"></i>Back to Templates
        </a>
      </div>

      <hr class="mt-4" style="border-color: var(--dd-border);">
    </div>
  </div>

  {% if bag_items %}

    <!-- =========================
         DESKTOP/TABLET (md and up)
         ========================= -->
    <div class="d-none d-md-block">

      <!-- Items list -->
      <div class="dd-card p-0 overflow-hidden">
        <div class="p-3" style="border-bottom: 1px solid var(--dd-border);">
          <div class="row" style="color: var(--dd-muted); font-size: .9rem;">
            <div class="col-2">Preview</div>
            <div class="col-4">Template</div>
            <div class="col-2 text-right">Unit price</div>
            <div class="col-2">Quantity</div>
            <div class="col-2 text-right">Subtotal</div>
          </div>
        </div>

        {% for item in bag_items %}
          <div class="p-3" style="border-bottom: 1px solid var(--dd-border);">
            <div class="row align-items-center">

              <!-- Image -->
              <div class="col-2">
                {% if item.product.image %}
                  <img class="img-fluid"
                       src="{{ item.product.image.url }}"
                       alt="{{ item.product.name }}"
                       style="border-radius: 14px; border: 1px solid var(--dd-border);">
                {% else %}
                  <img class="img-fluid"
                       src="{% static 'images/noimage.png' %}"
                       alt="{{ item.product.name }}"
                       style="border-radius: 14px; border: 1px solid var(--dd-border);">
                {% endif %}
              </div>

              <!-- Details -->
              <div class="col-4">
                <div style="font-weight: 800; color: var(--dd-text);">
                  {{ item.product.name }}
                </div>

                <div class="mt-2" style="color: var(--dd-muted); font-size: .92rem;">
                  {% if item.license_type %}
                    <span class="badge badge-white px-2 py-1 mr-1">
                      License: {{ item.license_type|title }}
                    </span>
                  {% endif %}

                  {% if item.product.category %}
                    <span class="badge badge-white px-2 py-1">
                      {{ item.product.category.friendly_name|default:item.product.category.name }}
                    </span>
                  {% endif %}
                </div>

                <div class="mt-2" style="color: var(--dd-muted); font-size: .85rem;">
                  ID: {{ item.item_id }}
                </div>
              </div>

              <!-- Unit price -->
              <div class="col-2 text-right">
                <div style="color: var(--dd-text); font-variant-numeric: tabular-nums;">
                  £{{ item.unit_price|floatformat:2 }}
                </div>
              </div>

              <!-- Quantity include -->
              <div class="col-2">
                {% include "bag/includes/quantity-form.html" %}
              </div>

              <!-- Subtotal -->
              <div class="col-2 text-right">
                <div style="font-weight: 800; color: var(--dd-text); font-variant-numeric: tabular-nums;">
                  £{{ item.line_total|floatformat:2 }}
                </div>
              </div>

            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Totals + Buttons -->
      <div class="row">
        <div class="col-12 col-md-6 offset-md-6 mt-4">
          <div class="dd-card p-4">
            {% include "bag/includes/bag-total.html" %}
            <div class="text-right mt-3">
              {% include "bag/includes/checkout-buttons.html" %}
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- =========================
         MOBILE (sm and down)
         ========================= -->
    <div class="d-block d-md-none">

      <!-- Totals + Buttons at top (mobile UX) -->
      <div class="dd-card p-4 mb-3">
        {% include "bag/includes/bag-total.html" %}
        <div class="text-right mt-3">
          {% include "bag/includes/checkout-buttons.html" %}
        </div>
        <p class="mt-3 mb-0" style="color: var(--dd-muted); font-size: .92rem;">
          Bag contents are listed below.
        </p>
      </div>

      {% for item in bag_items %}
        <div class="dd-card p-3 mb-3">

          <div class="row">

            {% include "bag/includes/product-image.html" %}
            {% include "bag/includes/product-info.html" %}

            <!-- Unit price + subtotal -->
            <div class="col-12 col-sm-3 mt-3 mt-sm-0">
              <p class="mb-1" style="color: var(--dd-muted); font-size: .92rem;">
                Unit price:
                <span style="color: var(--dd-text);">£{{ item.unit_price|floatformat:2 }}</span>
              </p>
              <p class="mb-0" style="font-weight: 800; color: var(--dd-text);">
                Subtotal: £{{ item.line_total|floatformat:2 }}
              </p>
            </div>

            <!-- Quantity -->
            {% include "bag/includes/quantity-form.html" %}

          </div>

        </div>
      {% endfor %}

      <!-- Back to top -->
      <div class="btt-button shadow-sm rounded-0"
           style="background: rgba(255,255,255,.06); border: 1px solid var(--dd-border);">
        <a class="btt-link d-flex h-100">
          <i class="fas fa-arrow-up mx-auto my-auto" style="color: var(--dd-text);"></i>
        </a>
      </div>

    </div>

  {% else %}
    <div class="dd-card p-4 mt-3">
      <p class="lead mb-3" style="color: var(--dd-text);">
        Your bag is empty.
      </p>
      <p class="mb-4" style="color: var(--dd-muted);">
        Browse templates and add something to get started.
      </p>
      <a href="{% url 'products' %}" class="btn btn-dd-primary text-uppercase">
        Browse Templates <i class="fas fa-arrow-right ml-2"></i>
      </a>
    </div>
  {% endif %}

</div>
{% endblock %}

{% block postloadjs %}
  {{ block.super }}
  {% include "bag/includes/quantity_input_script.html" %}

  <script>

    // Back to top
    $(".btt-link").click(function (e) {
      e.preventDefault();
      window.scrollTo(0, 0);
    });
  </script>
{% endblock %}
